<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>WebRTC Camera Sender</title>
    <style>
      body {
        font-family: sans-serif;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        background: #0f172a;
        color: #fff;
        height: 100vh;
      }
      video {
        width: 90%;
        max-width: 400px;
        border-radius: 10px;
        margin-top: 20px;
        background: #000;
      }
      input, button {
        margin: 8px;
        padding: 10px 14px;
        font-size: 1rem;
        border-radius: 8px;
        border: none;
      }
      button {
        background-color: #38bdf8;
        color: #000;
        font-weight: bold;
      }
    </style>
  </head>
  <body>
    <h2>ðŸ“¸ WebRTC Camera Sender</h2>
    <input id="roomInput" placeholder="Enter Room ID" />
    <button id="startBtn">Start Streaming</button>
    <video id="localVideo" autoplay playsinline muted></video>

    <script>
      const wsUrl = "wss://signaling-server-happymoves.onrender.com"; // â—replace with your deployed WebSocket URL
      let ws, pc, roomId;

      const startBtn = document.getElementById("startBtn");
      const localVideo = document.getElementById("localVideo");
      const roomInput = document.getElementById("roomInput");

      startBtn.onclick = async () => {
        roomId = roomInput.value.trim();
        if (!roomId) return alert("Enter a room ID!");

        ws = new WebSocket(wsUrl);

        ws.onopen = async () => {
          console.log("âœ… Connected to signaling server");
          ws.send(JSON.stringify({ type: "join", room: roomId }));
        };

        ws.onmessage = async (msg) => {
          const data = JSON.parse(msg.data);
          const { type, payload, from } = data;

          switch (type) {
            case "joined":
              console.log("Joined room:", payload.roomId);
              await setupMediaAndOffer();
              break;

            case "answer":
              console.log("âœ… Received answer from receiver");
              await pc.setRemoteDescription(new RTCSessionDescription(payload));
              break;

            case "ice-candidate":
              if (payload.candidate) {
                try {
                  await pc.addIceCandidate(new RTCIceCandidate(payload));
                  console.log("ðŸ’  Added ICE candidate");
                } catch (e) {
                  console.warn("âš ï¸ Error adding ICE candidate", e);
                }
              }
              break;
          }
        };

        ws.onclose = () => console.warn("âŒ WebSocket closed");
      };

      async function setupMediaAndOffer() {
        try {
          const stream = await navigator.mediaDevices.getUserMedia({
            video: true,
            audio: true,
          });
          localVideo.srcObject = stream;

          pc = new RTCPeerConnection({
            iceServers: [{ urls: "stun:stun.l.google.com:19302" }],
          });

          stream.getTracks().forEach((track) => pc.addTrack(track, stream));

          pc.onicecandidate = (event) => {
            if (event.candidate) {
              ws.send(
                JSON.stringify({
                  type: "ice-candidate",
                  room: roomId,
                  payload: event.candidate,
                })
              );
            }
          };

          const offer = await pc.createOffer();
          await pc.setLocalDescription(offer);

          ws.send(
            JSON.stringify({
              type: "offer",
              room: roomId,
              payload: offer,
            })
          );

          console.log("ðŸ“¡ Sent offer to room:", roomId);
        } catch (err) {
          console.error("ðŸŽ¥ Error accessing camera:", err);
          alert("Could not access camera/mic");
        }
      }
    </script>
  </body>
</html>
